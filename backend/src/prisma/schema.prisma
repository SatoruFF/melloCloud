// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Define User data model
model User {
  id           Int          @id @default(autoincrement())
  userName     String?
  email        String       @unique
  password     String
  storageGuid  String       @unique
  diskSpace    BigInt       @default(104857600)
  usedSpace    BigInt       @default(0)
  avatar       String?
  role         String       @default("USER")
  files        File[]
  isActivated  Boolean      @default(false)
  
  oauthProvider String?
  oauthId       String?
  
  userConfigs  UserConfig[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  Invite       Invite[]
  
  sessions     Session[]
  sentMessages Message[]
  chats        ChatUser[]
  notes        Note[]
  todos        Task[]
  assignedTasks Task[]      @relation("AssignedTasks")
  columns      TaskColumn[]
  
  // Календарь
  calendarEvents  CalendarEvent[]
  eventAttendees  EventAttendee[]
  
  // Feature flags
  userFeatureFlags UserFeatureFlag[]

  // Webhooks
  webhooks    Webhook[]
  
  // Permissions
  permissions Permission[] @relation("UserPermissions")
  grantedPermissions Permission[] @relation("GrantedPermissions")
  
  @@index([email])
  @@index([oauthProvider, oauthId])
}

// Session model
model Session {
  id            String    @id @default(uuid())
  userId        Int
  refreshToken  String    @unique
  userAgent     String    @default("Unknown")
  ip            String    @default("Unknown")
  lastActivity  DateTime  @default(now())
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([refreshToken])
  @@index([lastActivity])
}

model UserConfig {
  id        Int      @id @default(autoincrement())
  language  String?  @default("ENG")
  theme     String?  @default("DARK")
  userId    Int
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Define Invite data model
model Invite {
  id              Int      @id @default(autoincrement())
  userName        String?
  email           String   @unique
  password        String
  activationToken String   @unique
  isUsed          Boolean  @default(false)
  user            User?    @relation(fields: [userId], references: [id])
  userId          Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Define File data model
model File {
  id         Int       @id @default(autoincrement())
  name       String
  type       String?
  accessLink String?
  size       Int?      @default(0)
  path       String?   @default("")
  url        String?   @default("")
  user       User?     @relation(fields: [userId], references: [id])
  userId     Int
  parent     File?     @relation("ChildToParent", fields: [parentId], references: [id])
  parentId   Int?
  childs     File[]    @relation("ChildToParent")
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

// Define Chat data model
model Chat {
  id         Int        @id @default(autoincrement())
  title      String?
  isGroup    Boolean    @default(false)
  users      ChatUser[]
  messages   Message[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model ChatUser {
  id        Int      @id @default(autoincrement())
  userId    Int
  chatId    Int
  user      User     @relation(fields: [userId], references: [id])
  chat      Chat     @relation(fields: [chatId], references: [id])
  joinedAt  DateTime @default(now())
}

// Define Message data model
model Message {
  id        Int      @id @default(autoincrement())
  text      String
  senderId  Int
  chatId    Int
  sender    User     @relation(fields: [senderId], references: [id])
  chat      Chat     @relation(fields: [chatId], references: [id])
  createdAt DateTime @default(now())
}

// Define Note data model
model Note {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  isStarred Boolean  @default(false)
  isRemoved Boolean  @default(false)
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([isStarred])
}

// Define Column data model for Kanban
model TaskColumn {
  id        Int      @id @default(autoincrement())
  title     String
  color     String
  order     Int
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Define Task data model
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  description String?
  category    String?
  tag         String?
  priority    String   @default("LOW")
  status      String   @default("TODO")
  isDone      Boolean  @default(false)
  dueDate     DateTime?
  
  columnId    Int?
  column      TaskColumn?  @relation(fields: [columnId], references: [id], onDelete: SetNull)
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  assignedToId Int?
  assignedTo   User?   @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  parentTaskId Int?
  parentTask   Task?   @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks     Task[]  @relation("SubTasks")
  
  // Связь с календарём
  calendarEvent CalendarEvent?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================
// CALENDAR EVENTS
// =============================================

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  location    String?
  color       String   @default("#1890ff")
  category    String?
  
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean  @default(false)
  
  // Связь с задачами (опционально)
  taskId      Int?     @unique
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  // Recurring events
  isRecurring Boolean  @default(false)
  recurrenceRule String? // iCal RRULE format
  
  // Владелец события
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Участники события
  attendees   EventAttendee[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@index([taskId])
}

// Участники событий
model EventAttendee {
  id        Int      @id @default(autoincrement())
  eventId   Int
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status    String   @default("pending") // pending, accepted, declined
  
  createdAt DateTime @default(now())
  
  @@unique([eventId, userId])
  @@index([userId])
}

// =============================================
// UNIVERSAL PERMISSIONS SYSTEM (ACL)
// =============================================

enum ResourceType {
  NOTE
  TASK
  EVENT
  FILE
  FOLDER
  CHAT
  COLUMN
  KANBAN_BOARD
}

enum PermissionLevel {
  VIEWER
  COMMENTER
  EDITOR
  ADMIN
  OWNER
}

model Permission {
  id          Int      @id @default(autoincrement())
  
  // Приглашение по email (для незарегистрированных)
  email       String?
  
  // Субъект (кому выдаём права)
  subjectId   Int?
  subjectType String   @default("USER") // USER, ROLE, GROUP
  
  // Объект (на что выдаём права)
  resourceId  Int
  resourceType ResourceType
  
  // Уровень доступа
  permissionLevel PermissionLevel @default(VIEWER)
  
  // Публичные ссылки
  isPublic    Boolean  @default(false)
  publicToken String?  @unique
  
  // Метаданные
  grantedBy   Int?
  grantedByUser User?  @relation("GrantedPermissions", fields: [grantedBy], references: [id], onDelete: SetNull)
  
  expiresAt   DateTime?
  
  // Связь с пользователем
  user        User?    @relation("UserPermissions", fields: [subjectId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([subjectId, resourceId, resourceType])
  @@index([subjectId])
  @@index([resourceId, resourceType])
  @@index([resourceType])
  @@index([email])
  @@index([publicToken])
  @@index([isPublic])
}

// =============================================
// SHARING ACTIVITY LOG
// =============================================

enum ShareActivityType {
  SHARED
  PERMISSION_CHANGED
  PERMISSION_REVOKED
  ACCESSED
  DOWNLOADED
  EDITED
}

model ShareActivity {
  id          Int      @id @default(autoincrement())
  
  // Кто совершил действие
  actorId     Int
  actorEmail  String?
  
  // С кем/чем совершено действие
  targetId    Int?
  targetEmail String?
  
  // Что расшарили
  resourceType ResourceType
  resourceId   Int
  resourceName String?
  
  // Тип действия
  activityType ShareActivityType
  
  // Детали
  oldPermission PermissionLevel?
  newPermission PermissionLevel?
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([activityType])
}

// =============================================
// REAL-TIME COLLABORATION
// =============================================

model ActiveCollaborator {
  id          Int      @id @default(autoincrement())
  
  userId      Int
  userName    String
  userAvatar  String?
  
  resourceType ResourceType
  resourceId   Int
  
  // Где в документе находится курсор
  cursorPosition Json?
  
  // Какой раздел редактирует
  editingSection String?
  
  lastActivity   DateTime @default(now())
  
  @@unique([userId, resourceType, resourceId])
  @@index([resourceType, resourceId])
  @@index([lastActivity])
}

// =============================================
// FEATURE FLAGS
// =============================================

model FeatureFlag {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(false)
  
  rolloutPercentage Int @default(0)
  
  enabledForUsers UserFeatureFlag[]
  
  environment String   @default("production")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
  @@index([isEnabled])
  @@index([environment])
}

model UserFeatureFlag {
  id            Int      @id @default(autoincrement())
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  featureFlagId Int
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  
  isEnabled     Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, featureFlagId])
  @@index([userId])
  @@index([featureFlagId])
}

// =============================================
// WEBHOOKS SYSTEM
// =============================================

enum WebhookEvent {
  // Calendar events
  EVENT_CREATED
  EVENT_UPDATED
  EVENT_DELETED
  EVENT_REMINDER_1H
  EVENT_REMINDER_1D
  EVENT_REMINDER_CUSTOM
  
  // Tasks events
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_OVERDUE
  TASK_DUE_SOON
  
  // Notes events
  NOTE_CREATED
  NOTE_UPDATED
  NOTE_SHARED
  
  // File events
  FILE_UPLOADED
  FILE_SHARED
  
  // Custom
  CUSTOM
}

enum WebhookStatus {
  ACTIVE
  INACTIVE
  FAILED
  PAUSED
}

enum WebhookMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

model Webhook {
  id          Int      @id @default(autoincrement())
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  url         String
  method      WebhookMethod @default(POST)
  
  events      WebhookEvent[]
  
  filters     Json?
  headers     Json?
  
  retryCount  Int      @default(3)
  retryDelay  Int      @default(60)
  
  status      WebhookStatus @default(ACTIVE)
  
  lastTriggeredAt DateTime?
  successCount    Int @default(0)
  failureCount    Int @default(0)
  
  executions  WebhookExecution[]
  scheduledWebhooks ScheduledWebhook[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([events])
}

model WebhookExecution {
  id          Int      @id @default(autoincrement())
  
  webhookId   Int
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  event       WebhookEvent
  payload     Json
  
  statusCode  Int?
  response    Json?
  error       String?
  duration    Int?
  
  attempt     Int      @default(1)
  success     Boolean  @default(false)
  
  triggeredAt DateTime @default(now())
  
  @@index([webhookId])
  @@index([triggeredAt])
  @@index([success])
}

model ScheduledWebhook {
  id          Int      @id @default(autoincrement())
  
  webhookId   Int
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  resourceType String
  resourceId   Int
  
  scheduledFor DateTime
  executed     Boolean  @default(false)
  executedAt   DateTime?
  
  event        WebhookEvent
  payload      Json
  
  createdAt    DateTime @default(now())
  
  @@index([scheduledFor, executed])
  @@index([webhookId])
  @@index([resourceType, resourceId])
}
