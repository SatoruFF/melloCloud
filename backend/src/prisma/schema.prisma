// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Define User data model
model User {
  id           Int          @id @default(autoincrement())
  userName     String?
  email        String       @unique
  password     String
  storageGuid  String       @unique
  diskSpace    BigInt       @default(104857600)
  usedSpace    BigInt       @default(0)
  avatar       String?
  role         String       @default("USER")
  files        File[]
  isActivated  Boolean      @default(false)
  
  oauthProvider String?
  oauthId       String?
  
  userConfigs  UserConfig[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  Invite       Invite[]
  
  sessions     Session[]
  sentMessages Message[]
  chats        ChatUser[]
  notes        Note[]
  todos        Task[]
  assignedTasks Task[]      @relation("AssignedTasks")
  columns      TaskColumn[]
  
  // Календарь
  calendarEvents  CalendarEvent[]
  eventAttendees  EventAttendee[]
  
  // Feature flags
  userFeatureFlags UserFeatureFlag[]

  // Webhooks
  webhooks    Webhook[]
  
  @@index([email])
  @@index([oauthProvider, oauthId])
}

// Session model
model Session {
  id            String    @id @default(uuid())
  userId        Int
  refreshToken  String    @unique
  userAgent     String    @default("Unknown")
  ip            String    @default("Unknown")
  lastActivity  DateTime  @default(now())
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([refreshToken])
  @@index([lastActivity])
}

model UserConfig {
  id        Int      @id @default(autoincrement())
  language  String?  @default("ENG")
  theme     String?  @default("DARK")
  userId    Int
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Define Invite data model
model Invite {
  id              Int      @id @default(autoincrement())
  userName        String?
  email           String   @unique
  password        String
  activationToken String   @unique
  isUsed          Boolean  @default(false)
  user            User?    @relation(fields: [userId], references: [id])
  userId          Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Define File data model
model File {
  id         Int       @id @default(autoincrement())
  name       String
  type       String?
  accessLink String?
  size       Int?      @default(0)
  path       String?   @default("")
  url        String?   @default("")
  user       User?     @relation(fields: [userId], references: [id])
  userId     Int
  parent     File?     @relation("ChildToParent", fields: [parentId], references: [id])
  parentId   Int?
  childs     File[]    @relation("ChildToParent")
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

// Define Chat data model
model Chat {
  id         Int        @id @default(autoincrement())
  title      String?
  isGroup    Boolean    @default(false)
  users      ChatUser[]
  messages   Message[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model ChatUser {
  id        Int      @id @default(autoincrement())
  userId    Int
  chatId    Int
  user      User     @relation(fields: [userId], references: [id])
  chat      Chat     @relation(fields: [chatId], references: [id])
  joinedAt  DateTime @default(now())
}

// Define Message data model
model Message {
  id        Int      @id @default(autoincrement())
  text      String
  senderId  Int
  chatId    Int
  sender    User     @relation(fields: [senderId], references: [id])
  chat      Chat     @relation(fields: [chatId], references: [id])
  createdAt DateTime @default(now())
}

// Define Note data model
model Note {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  isStarred Boolean  @default(false)
  isRemoved Boolean  @default(false)
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([isStarred])
}

// Define Column data model for Kanban
model TaskColumn {
  id        Int      @id @default(autoincrement())
  title     String
  color     String
  order     Int
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Define Task data model
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  description String?
  category    String?
  tag         String?
  priority    String   @default("LOW")
  status      String   @default("TODO")
  isDone      Boolean  @default(false)
  dueDate     DateTime?
  
  columnId    Int?
  column      TaskColumn?  @relation(fields: [columnId], references: [id], onDelete: SetNull)
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  assignedToId Int?
  assignedTo   User?   @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  parentTaskId Int?
  parentTask   Task?   @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks     Task[]  @relation("SubTasks")
  
  // Связь с календарём
  calendarEvent CalendarEvent?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================
// CALENDAR EVENTS
// =============================================

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  location    String?
  color       String   @default("#1890ff")
  category    String?
  
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean  @default(false)
  
  // Связь с задачами (опционально)
  taskId      Int?     @unique
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  // Recurring events
  isRecurring Boolean  @default(false)
  recurrenceRule String? // iCal RRULE format
  
  // Владелец события
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Участники события
  attendees   EventAttendee[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@index([taskId])
}

// Участники событий
model EventAttendee {
  id        Int      @id @default(autoincrement())
  eventId   Int
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status    String   @default("pending") // pending, accepted, declined
  
  createdAt DateTime @default(now())
  
  @@unique([eventId, userId])
  @@index([userId])
}

// =============================================
// UNIVERSAL PERMISSIONS SYSTEM (ACL)
// =============================================

enum ResourceType {
  NOTE
  TASK
  EVENT
  FILE
  CHAT
  COLUMN
}

model Permission {
  id          Int      @id @default(autoincrement())
  
  // Субъект (кому выдаём права)
  subjectId   Int      // userId
  subjectType String   @default("USER") // USER, ROLE, GROUP (для будущего)
  
  // Объект (на что выдаём права)
  resourceId  Int      // id заметки/задачи/события
  resourceType ResourceType // NOTE, TASK, EVENT, FILE, etc.
  
  // Уровень доступа (битовая маска)
  // 2 = AVAILABLE
  // 8 = SEARCH
  // 32 = READ
  // 128 = EDIT
  // 512 = CREATE
  // 1024 = EXPORT
  // 2048 = DELETE
  // 8192 = ACCESS
  // 32768 = ADMIN
  // 131072 = DENY
  level       Int      @default(32) // по умолчанию READ
  
  // Метаданные
  grantedBy   Int?     // кто выдал права
  expiresAt   DateTime? // срок действия (опционально)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([subjectId, resourceId, resourceType])
  @@index([subjectId])
  @@index([resourceId, resourceType])
  @@index([resourceType])
}

// =============================================
// FEATURE FLAGS
// =============================================

model FeatureFlag {
  id          Int      @id @default(autoincrement())
  key         String   @unique // "calendar_sharing", "task_recurring", "ai_assistant"
  name        String   // Человекочитаемое название
  description String?
  isEnabled   Boolean  @default(false)
  
  // Для A/B тестирования
  rolloutPercentage Int @default(0) // 0-100
  
  // Для конкретных пользователей
  enabledForUsers UserFeatureFlag[]
  
  // Для конкретных окружений
  environment String   @default("production") // production, staging, development
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
  @@index([isEnabled])
  @@index([environment])
}

model UserFeatureFlag {
  id            Int      @id @default(autoincrement())
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  featureFlagId Int
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  
  isEnabled     Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, featureFlagId])
  @@index([userId])
  @@index([featureFlagId])
}

// =============================================
// WEBHOOKS SYSTEM
// =============================================

enum WebhookEvent {
  // Calendar events
  EVENT_CREATED
  EVENT_UPDATED
  EVENT_DELETED
  EVENT_REMINDER_1H    // за 1 час до события
  EVENT_REMINDER_1D    // за 1 день до события
  EVENT_REMINDER_CUSTOM
  
  // Tasks events
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_OVERDUE
  TASK_DUE_SOON
  
  // Notes events
  NOTE_CREATED
  NOTE_UPDATED
  NOTE_SHARED
  
  // File events
  FILE_UPLOADED
  FILE_SHARED
  
  // Custom
  CUSTOM
}

enum WebhookStatus {
  ACTIVE
  INACTIVE
  FAILED
  PAUSED
}

enum WebhookMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

// Webhook subscription
model Webhook {
  id          Int      @id @default(autoincrement())
  
  // Владелец webhook
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Конфигурация
  name        String   // "Telegram Bot Reminder"
  description String?
  url         String   // куда отправлять (https://api.telegram.org/bot...)
  method      WebhookMethod @default(POST)
  
  // На какие события подписан
  events      WebhookEvent[] // массив событий
  
  // Фильтры (JSON)
  filters     Json?    // { "eventCategory": "Meeting", "taskPriority": "HIGH" }
  
  // Headers для запроса
  headers     Json?    // { "Authorization": "Bearer token", "X-Custom": "value" }
  
  // Retry policy
  retryCount  Int      @default(3)
  retryDelay  Int      @default(60) // секунды между попытками
  
  // Статус
  status      WebhookStatus @default(ACTIVE)
  
  // Статистика
  lastTriggeredAt DateTime?
  successCount    Int @default(0)
  failureCount    Int @default(0)
  
  // История выполнений
  executions  WebhookExecution[]
  scheduledWebhooks ScheduledWebhook[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([events])
}

// История выполнений webhook
model WebhookExecution {
  id          Int      @id @default(autoincrement())
  
  webhookId   Int
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  // Детали события
  event       WebhookEvent
  payload     Json     // данные которые отправили
  
  // Результат
  statusCode  Int?
  response    Json?    // ответ от сервера
  error       String?
  duration    Int?     // миллисекунды
  
  // Попытки
  attempt     Int      @default(1)
  success     Boolean  @default(false)
  
  triggeredAt DateTime @default(now())
  
  @@index([webhookId])
  @@index([triggeredAt])
  @@index([success])
}

// Scheduled webhooks (для напоминаний)
model ScheduledWebhook {
  id          Int      @id @default(autoincrement())
  
  webhookId   Int
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  // Связь с ресурсом
  resourceType String  // "EVENT", "TASK", "NOTE"
  resourceId   Int     // id события/задачи/заметки
  
  // Когда запустить
  scheduledFor DateTime
  executed     Boolean  @default(false)
  executedAt   DateTime?
  
  // Данные для отправки
  event        WebhookEvent
  payload      Json
  
  createdAt    DateTime @default(now())
  
  @@index([scheduledFor, executed])
  @@index([webhookId])
  @@index([resourceType, resourceId])
}
