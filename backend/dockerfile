FROM oven/bun:1-alpine

# OpenSSL required by Prisma
RUN apk add --no-cache openssl

WORKDIR /app

COPY package.json ./
COPY pnpm-lock.yaml* package-lock.json* ./
COPY src/prisma ./src/prisma

# Install dependencies (skip postinstall: migrate deploy needs DATABASE_URL at runtime)
RUN bun install --ignore-scripts

COPY . .

RUN bunx prisma generate

EXPOSE 1337

# Run migrations and start app (Bun runs TS without a separate build)
CMD ["sh", "-c", "bunx prisma migrate deploy && bun run src/server.bun.ts"]
