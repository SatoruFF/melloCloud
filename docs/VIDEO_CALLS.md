# Видеозвонки и шаринг экрана в чатах

## Цели

- Видео/аудио звонки в личных и групповых чатах
- Шаринг экрана (для вебинаров и демо)
- Звонок не должен обрываться при переключении на другие вкладки

## Готовые решения

### 1. **LiveKit** (рекомендуется для своей платформы)

- **Сайт:** https://livekit.io
- **React:** `@livekit/components-react`, `livekit-client`
- **Возможности:** видео, аудио, шаринг экрана, запись, кастомный UI
- **Self-host:** да, сервер LiveKit + свой token server (Node/TS пример: [livekit-examples/token-server-node](https://github.com/livekit-examples/token-server-node))
- **Плюсы:** полный контроль над UI, встраивается в ваш чат; стабильный WebRTC
- **Минусы:** нужен свой сервер (или LiveKit Cloud)

**Установка (frontend):**
```bash
pnpm add livekit-client @livekit/components-react
```

**Backend:** отдельный сервис/эндпоинт для выдачи JWT-токенов по `roomName` и `participantIdentity` (привязать к вашему `userId` и `chatId`).

---

### 2. **Jitsi Meet** (быстрый старт, свой сервер или meet.jit.si)

- **Сайт:** https://jitsi.org
- **React:** `@jitsi/react-sdk` — компонент `JitsiMeeting`
- **Возможности:** видео, аудио, шаринг экрана, запись, чат внутри комнаты
- **Self-host:** да (Jitsi Meet на своём сервере) или бесплатный хостинг meet.jit.si
- **Плюсы:** быстро встроить через iframe/React, привычный интерфейс как у Zoom
- **Минусы:** UI в основном стандартный Jitsi (кастомизация ограничена)

**Установка:**
```bash
pnpm add @jitsi/react-sdk
```

**Пример:** комната = `chatId` или `chatId-userId`, имя участника = ваш displayName из профиля.

---

### 3. **Daily.co** / **Twilio Video**

- Готовые SDK, шаринг экрана есть
- Обычно cloud-only (аренда минутов), self-host сложнее
- Имеет смысл, если не хотите поднимать свой медиа-сервер

---

## Проблема: фоновая вкладка

Браузеры (Chrome, Safari, Firefox) **ограничивают** работу вкладок в фоне: реже выполняют таймеры, могут приостанавливать WebRTC/медиа.

**Что делать:**

1. **Открывать звонок в отдельном окне** (рекомендуется)  
   Кнопка «Видеозвонок» в чате открывает `window.open(.../call?room=...)`. Пользователь держит окно звонка открытым, а чат — в другой вкладке. Окно не считается «фоновой вкладкой», медиа и WebRTC работают стабильно.

2. **Подсказка пользователю**  
   При сворачивании вкладки со звонком показывать: «Для стабильного звонка откройте его в отдельном окне» + кнопка «Открыть в новом окне».

3. **Reconnect при возврате**  
   LiveKit и многие SDK умеют переподключаться при возврате на вкладку; можно показывать «Переподключение…» и автоматически восстанавливать звонок.

4. **Picture-in-Picture**  
   Часть браузеров позволяют вынести видео в PiP — тогда вкладка может быть в фоне, но медиа продолжает идти (зависит от браузера и реализации).

**Итог:** самый надёжный вариант для «не вырубаться при переходах по вкладкам» — **звонок в отдельном окне**.

---

## Шаринг экрана

- **LiveKit:** публикация screen track через SDK (`createScreenTracks`, затем `room.localParticipant.publishTrack(...)`).
- **Jitsi:** кнопка «Поделиться экраном» есть в стандартном UI.
- **WebRTC:** `getDisplayMedia()` — все платформы поверх этого API.

Для вебинаров: один участник включает шаринг экрана, остальные смотрят; при необходимости можно ограничить, кто может шарить (например, только создатель комнаты/модератор).

---

## План интеграции (на примере LiveKit)

### Backend

1. **LiveKit Server** (self-host или LiveKit Cloud)  
   - Локально: `livekit-server --dev` или Docker по [документации](https://docs.livekit.io/home/self-hosting/server-setup/).

2. **Token API** в вашем backend (Hono/Express):  
   - Эндпоинт `POST /calls/token` (или `/api/calls/token`).  
   - Тело: `{ roomName: string, participantName?: string }` или привязка к `chatId`.  
   - Проверка авторизации (ваш JWT), генерация LiveKit Access Token (JWT с `api_key`, `api_secret`, `room`, `identity`, `name`) и возврат клиенту.

3. **Привязка к чатам**  
   - `roomName` = например `chat-${chatId}` для группового или `dm-${chatId}` для личного.  
   - В БД при желании можно хранить `call_room_id` для чата и метаданные (кто создал, время).

### Frontend

1. **Страница/маршрут звонка**  
   - Например `/chats/:chatId/call` или `/call?room=...&token=...`  
   - Открывается по кнопке «Видеозвонок» в шапке чата (или в меню).  
   - Желательно открывать в **новом окне** (`window.open`), чтобы не обрывалось при переключении вкладок.

2. **Компонент комнаты**  
   - Использовать `LiveKitRoom` из `@livekit/components-react`.  
   - Передавать `serverUrl`, `token` (полученный с вашего backend), опции (авто-подключение, видео/аудио по умолчанию).  
   - В тулбаре комнаты: кнопки «Вкл/выкл камеры», «Вкл/выкл микрофона», **«Шаринг экрана»** (публикация screen track).

3. **Кнопка в чате**  
   - В `ChatHeader` или рядом: иконка видеозвонка → запрос токена по `chatId` → открытие `/call?room=...&token=...` в новом окне.

4. **Уведомления**  
   - При создании звонка можно отправить в чат служебное сообщение: «Иван начал видеозвонок» со ссылкой/кнопкой «Присоединиться».

---

## Альтернатива: Jitsi (быстрый вариант)

Если не хотите поднимать LiveKit Server и token server:

1. Использовать **meet.jit.si** или свой Jitsi Meet.
2. Установить `@jitsi/react-sdk`.
3. В чате по кнопке «Видеозвонок» открывать в **новом окне** страницу с `<JitsiMeeting roomName={chatId} />` (и при необходимости JWT для своего домена).
4. Комната = уникальное имя по `chatId`; шаринг экрана уже есть в интерфейсе Jitsi.

Минус: меньше кастомизации и привязки к вашему дизайну; плюс: быстрее внедрить и не нужен свой медиа-сервер.

---

## Резюме

| Критерий              | LiveKit                    | Jitsi Meet                 |
|-----------------------|----------------------------|-----------------------------|
| Кастомный UI          | Да                         | Ограничен (iframe/SDK)      |
| Self-host             | Да (сервер + token server) | Да (или meet.jit.si)        |
| Шаринг экрана         | Да                         | Да                          |
| Фоновая вкладка       | Решение: отдельное окно    | То же                       |
| Интеграция в ваш чат  | Глубокая                   | Через iframe/отдельная страница |

**Рекомендация:** для «своей площадки» с вебинарами и шарингом экрана — **LiveKit** (self-host или cloud) + **открытие звонка в отдельном окне**, чтобы звонки не обрывались при переключении вкладок. Для самого быстрого старта без своего сервера — **Jitsi** (meet.jit.si или свой инстанс).
